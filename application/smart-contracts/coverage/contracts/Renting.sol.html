<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\Renting.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> Renting.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">98.59% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>70/71</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">62.9% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>39/62</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>16/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">98.65% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>73/74</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-yes">51×</span>
<span class="cline-any cline-yes">48×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity &gt;= 0.5.0 &lt; 0.7.0;
&nbsp;
import "./IdentityOracle.sol";
import "./Ownable.sol";
&nbsp;
contract Renting is Ownable {
&nbsp;
  //possible states of an agreement
  enum AgreementState {
    Pending,
    Active,
    Terminated
  }
&nbsp;
  RentalAgreement[] private agreements;
&nbsp;
  struct RentalAgreement {
    address payable tenant;
    bytes tenantSignature;
    address payable lessor;
    bytes lessorSignature;
    address device;
    uint usageFee;        //
    uint contractTerm;    //unix timestamp
    uint creation;        //unix timestamp
    AgreementState state;
  }
&nbsp;
  mapping(address =&gt; mapping(bytes32 =&gt; Payment)) private payments;
&nbsp;
  struct Payment {
    uint timestamp;
    address device;
    address payer;
    uint amount;
  }
&nbsp;
  address private oracle_addr;
  address payable public owner;
&nbsp;
  constructor() public {
    owner = msg.sender;
  }
&nbsp;
  function destroy() public {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == owner, "Only owner can call this function.");
    selfdestruct(owner);
  }
&nbsp;
  /// @notice asks registered oracle whether the identity is known or not
  /// @param _addr the address of the identity address
  /// @param _roleID the role of the identity
  /// @return a boolean whether or not the identity is known
  function isKnownParticipant(address _addr, uint _roleID) public view returns(bool) {
      IdentityOracle oracle = IdentityOracle(oracle_addr);
      if(oracle.identityExists(_addr) &amp;&amp; oracle.getIdentityRole(_addr) == _roleID) {
        return true;
      } else {
        return false;
      }
  }
&nbsp;
  /// @notice sets the oracle address
  /// @dev only callable by owner
  /// @param _addr the address of the orcle
  function registerIdentityOracle(address _addr) public onlyOwner {
    oracle_addr = _addr;
  }
&nbsp;
  /// @notice creates a rentalAgreement
  /// @param _tenant address of the tenant
  /// @param _lessorSignature signature of lessor of rentalAgreement
  /// @param _device address of device
  /// @param _usageFee fee for usage in wei
  /// @param _contractTerm timestamp, when rentalAgreement times out
  function create(address payable _tenant, bytes memory _lessorSignature, address _device, uint _usageFee, uint _contractTerm) public {
    //check if sender is Manufacturer, tenant is Customer and device is Device
    <span class="missing-if-branch" title="else path not taken" >E</span>require(isKnownParticipant(msg.sender, 1));
    require(isKnownParticipant(_tenant, 2));
    <span class="missing-if-branch" title="else path not taken" >E</span>require(isKnownParticipant(_device, 5));
    //check lessorSignature
    bytes32 message = keccak256(abi.encodePacked(_tenant, msg.sender, _device, _usageFee, _contractTerm));
    bytes memory prefix = "\x19Ethereum Signed Message:\n32";
    <span class="missing-if-branch" title="else path not taken" >E</span>require(recoverSigner(keccak256(abi.encodePacked(prefix, message)), _lessorSignature) == msg.sender);
    //check contractTerm to be in future!
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_contractTerm &gt; now);
    //check that no rentalAgreement with same parameters exists
    <span class="missing-if-branch" title="else path not taken" >E</span>require(!exists(_lessorSignature));
    agreements.push(RentalAgreement(_tenant, new bytes(65), msg.sender, _lessorSignature, _device, _usageFee, _contractTerm, now, AgreementState.Pending));
  }
&nbsp;
  function exists(bytes memory _lessorSignature) private view returns (bool) {
    for(uint i = 0; i &lt; agreements.length; i++) {
      <span class="missing-if-branch" title="if path not taken" >I</span>if(keccak256(agreements[i].lessorSignature) == keccak256(_lessorSignature)) {
<span class="cstat-no" title="statement not covered" >        return true;</span>
      }
    }
    return false;
  }
&nbsp;
  function getIDs(uint _stateID) public returns (uint[] memory) {
    uint count = 0;
    for(uint i = 0; i &lt; agreements.length; i++) {
      if(agreements[i].tenant == msg.sender &amp;&amp; agreements[i].state == AgreementState(_stateID) ) {
        count++;
      }
    }
    uint[] memory rentalAgreementIDs = new uint[](count);
    uint index = 0;
    for(uint i = 0; i &lt; agreements.length; i++) {
      if(agreements[i].tenant == msg.sender &amp;&amp; agreements[i].state == AgreementState(_stateID) ) {
        rentalAgreementIDs[index] = i;
        index++;
      }
    }
    return rentalAgreementIDs;
  }
&nbsp;
  function getByID(uint _id) public view returns (address _tenant, bytes memory _tenantSignature, address _lessor, bytes memory _lessorSignature, address _device, uint _usageFee, uint _contractTerm, uint _state) {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_id &lt; agreements.length);
    RentalAgreement memory agreement = agreements[_id];
    require(msg.sender == agreement.tenant || msg.sender == agreement.lessor);
    return (agreement.tenant, agreement.tenantSignature, agreement.lessor, agreement.lessorSignature, agreement.device, agreement.usageFee, agreement.contractTerm, uint256(agreement.state));
&nbsp;
  }
&nbsp;
  function accept(uint _id, bytes memory _signature) public {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_id &lt; agreements.length);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(agreements[_id].state == AgreementState.Pending);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(agreements[_id].tenant == msg.sender);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(recoverSigner(getRentalAgreementHash(_id), _signature) == msg.sender);
    agreements[_id].tenantSignature = _signature;
    agreements[_id].state = AgreementState(1);
  }
&nbsp;
  function splitSignature(bytes memory _sig) internal pure returns (uint8 v, bytes32 r, bytes32 s) {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_sig.length == 65);
    assembly {
        // first 32 bytes, after the length prefix.
        r := mload(add(_sig, 32))
        // second 32 bytes.
        s := mload(add(_sig, 64))
        // final byte (first byte of the next 32 bytes).
        v := byte(0, mload(add(_sig, 96)))
    }
    <span class="missing-if-branch" title="else path not taken" >E</span>if (v &lt; 27) {
      v += 27;
    }
&nbsp;
    <span class="missing-if-branch" title="else path not taken" >E</span>require (v == 27 || v == 28);
    return (v, r, s);
  }
&nbsp;
  function recoverSigner(bytes32 _message, bytes memory _sig) internal pure returns (address) {
    (uint8 v, bytes32 r, bytes32 s) = splitSignature(_sig);
    return ecrecover(_message, v, r, s);
  }
&nbsp;
  function payForUsage(uint _id, uint _timestamp) payable public {
    //todo: check _timestamp to be in the past!
    require(_id &lt; agreements.length);
    RentalAgreement memory rentalAgreement = agreements[_id];
    //rentalAgreement must be accepted (and therefore signed) by sender
    require(recoverSigner(getRentalAgreementHash(_id), rentalAgreement.tenantSignature) == msg.sender);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == rentalAgreement.tenant);
    require(msg.value == rentalAgreement.usageFee);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(rentalAgreement.state == AgreementState.Active);
    rentalAgreement.lessor.transfer(msg.value);
    bytes32 paymentHash = getPaymentHash(_timestamp, rentalAgreement.device, msg.sender, msg.value);
    payments[rentalAgreement.lessor][paymentHash] = Payment(_timestamp, rentalAgreement.device, msg.sender, msg.value);
  }
&nbsp;
  function getRentalAgreementHash(uint _id) private returns (bytes32) {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_id &lt; agreements.length);
    bytes32 message = keccak256(abi.encodePacked(agreements[_id].tenant, agreements[_id].lessor, agreements[_id].device, agreements[_id].usageFee, agreements[_id].contractTerm));
    bytes memory prefix = "\x19Ethereum Signed Message:\n32";
    return keccak256(abi.encodePacked(prefix, message));
  }
&nbsp;
  function getPaymentHash(uint _timestamp, address _device, address _payer, uint _amount) public view returns (bytes32) {
    bytes32 message = keccak256(abi.encodePacked(_timestamp, _device, _payer, _amount));
    // bytes memory prefix = "\x19Ethereum Signed Message:\n32";
    // return keccak256(abi.encodePacked(prefix, message));
    return message;
  }
&nbsp;
  function checkUsagePayment(uint _agreementID, bytes32 _paymentHash) public view returns(uint, address, address, uint) {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_agreementID &lt; agreements.length);
    RentalAgreement memory rentalAgreement = agreements[_agreementID];
    <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == rentalAgreement.device);
    return (payments[rentalAgreement.lessor][_paymentHash].timestamp, payments[rentalAgreement.lessor][_paymentHash].device, payments[rentalAgreement.lessor][_paymentHash].payer, payments[rentalAgreement.lessor][_paymentHash].amount);
  }
&nbsp;
  function terminate(uint _agreementID) public {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_agreementID &lt; agreements.length);
    RentalAgreement memory rentalAgreement = agreements[_agreementID];
    <span class="missing-if-branch" title="else path not taken" >E</span>require(rentalAgreement.state == AgreementState.Active);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == rentalAgreement.tenant || msg.sender == rentalAgreement.lessor);
    agreements[_agreementID].state = AgreementState.Terminated;
  }
&nbsp;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Jan 16 2020 10:01:24 GMT+0100 (GMT+01:00)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
